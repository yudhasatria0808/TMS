@using tms_mka_v2.Models;

@model tms_mka_v2.Models.SalesOrderKontrak
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    string currentController = (string)ViewContext.RouteData.Values["controller"];
    string currentAction = ViewBag.PostData;
    string backLink = Url.Action("Index");
}
<style>
    .fc-event {
        border: 1px solid #3a87ad;
        background-color: #0026ff;
        height: 60px !important;
    }
</style>
<script src="~/Content/metronic/assets/global/scripts/date.js" type="text/javascript"></script>
<div class="portlet light">
    <div class="portlet-title">
        <div class="caption">
            <span class="caption-subject font-dark sbold uppercase">@ViewBag.Title</span>
        </div>
    </div>
    <div class="portlet-body form">
        @using (@Html.BeginForm(currentAction, currentController, FormMethod.Post, new { @class = "form-horizontal", @id = "formsubmit" }))
        {
            @Html.ValidationSummary(true)
            @Html.HiddenFor(model => model.SalesOrderId)
            @Html.HiddenFor(model => model.SalesOrderKontrakId)
            @Html.HiddenFor(model => model.Status)
            @Html.HiddenFor(model => model.JenisTruckId)
            <input type="hidden" id="DataTruckId" name="DataTruckId"/>
            <input type="hidden" id="IdDriver1" name="IdDriver1"/>
            <input type="hidden" id="IdDriver2" name="IdDriver2"/>
            <div class="portlet light">
                <div class="portlet-title">
                    <div class="caption font-green-sharp">
                        <span class="caption-subject"> Basic Info</span>
                    </div>
                    <div class="tools">
                        <a href="" class="collapse"> </a>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label col-md-3"> No Kontrak</label>
                                <label class="control-label col-md-9">: @ViewBag.so_detail.NoSo</label>
                                @Html.HiddenFor(model => model.SONumber, new { @Value = ViewBag.so_detail.NoSo })
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3"> Kode Customer</label>
                                <label class="control-label col-md-9">: @Model.KodeCustomer</label>
                                @Html.HiddenFor(model => model.KodeCustomer)
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3"> Nama Customer</label>
                                <label class="control-label col-md-9">: @Model.NamaCustomer</label>
                                @Html.HiddenFor(model => model.NamaCustomer)
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3"> Status Kredit</label>
                                <label class="control-label col-md-9">: @Model.StatusKredit</label>
                                @Html.HiddenFor(model => model.StatusKredit)
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3"> Jenis Barang</label>
                                <label class="control-label col-md-9">: @Model.StrProduct</label>
                                @Html.HiddenFor(model => model.StrProduct)
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3"> Suhu</label>
                                <label class="control-label col-md-9">: @Model.Suhu <sup>o</sup>C</label>
                                @Html.HiddenFor(model => model.Suhu)
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label col-md-3">Periode</label>
                                @Html.TextBoxFor(model => model.PeriodStr, new { @class = "form-control input-sm hidden" })
                                @Html.ValidationMessageFor(model => model.PeriodStr)

                                @Html.TextBoxFor(model => model.PeriodEnd, new { @class = "form-control input-sm hidden" })
                                @Html.ValidationMessageFor(model => model.PeriodEnd)
                                <div class="col-md-9 col-sm-9 col-xs-12">
                                    <label class="control-label col-md-4">: @ViewBag.so_detail.MuatDate.ToShortDateString()</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3">Jam Muat</label>
                                <div class="col-md-3 col-sm-9 col-xs-12">
                                    <label class="control-label col-md-9">: @Model.JamMuat</label>
                                    @Html.HiddenFor(model => model.JamMuat)
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3">Jenis Truk</label>
                                <div class="col-md-3 col-sm-9 col-xs-12">
                                    <label class="control-label col-md-9">: @Model.StrJenisTruck</label>
                                    @Html.HiddenFor(model => model.StrJenisTruck)
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3">Jumlah Truk</label>
                                <div class="col-md-3 col-sm-9 col-xs-12">
                                    <label class="control-label col-md-9">: 1</label>
                                    @Html.HiddenFor(model => model.JumlahTruck)
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3">Rit</label>
                                <div class="col-md-3 col-sm-9 col-xs-12">
                                    <label class="control-label col-md-9">: @Model.Rit</label>
                                    @Html.HiddenFor(model => model.Rit)
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3">Keterangan</label>
                                <div class="col-md-3 col-sm-9 col-xs-12">
                                    <label class="control-label col-md-9">: @Model.Keterangan</label>
                                    @Html.HiddenFor(model => model.Keterangan)
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <br />
            @*<div class="row">*@
            <div class="portlet light">
                <div class="portlet-title">
                    <div class="caption font-green-sharp">
                        <span class="caption-subject"> Tanggal Muat</span>
                    </div>
                    <div class="tools">
                        <a href="" class="collapse"> </a>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <div id="calendars"></div>
                                @Html.HiddenFor(model => model.JsonDateMuat)
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label col-md-3"> Jumlah Hari</label>
                                <label class="control-label col-md-9">: @Model.JumHari</label>
                                @Html.HiddenFor(model => model.JumHari)
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3"> Hari Kerja</label>
                                <label class="control-label col-md-9">: @Model.Kerja</label>
                                @Html.HiddenFor(model => model.Kerja)
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3"> Jumlah Libur</label>
                                <label class="control-label col-md-9">: @Model.libur</label>
                                @Html.HiddenFor(model => model.libur)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            @*</div>*@
            if (ViewBag.kondisi == "inputdp")
            {
                <br />
                @*@Html.Partial("SalesOrderKontrak/_InputDp", Model)*@
                <div class="row">
                    <br />
                    <div class="form-group">
                        <div class="col-md-12" style="margin:0px 15px 0px 15px">
                            <a href="@Url.Action("Index","ListOrder")" class="btn btn-link" style="width:100px">Cancel</a>
                        </div>
                    </div>
                </div>
            }
            if (ViewBag.kondisi == "planning")
            {
                @Html.Partial("SalesOrderKontrak/_OperationalTruck", Model)
                <div class="row">
                    <br />
                    <div class="form-group">
                        <div class="col-md-12">
                            <button type="button" value="save planning" class="btn btn-success" onclick="notifSave($('#formsubmit'),$(this).val());">Submit</button>
                            <!--klo ngebug tinggal balikin notifSaveSubmitKontrak ke notifSave, heheh-->
                            <button type="submit" name="btnsave" value="draft planning" class="btn btn-success">Save As Draft</button>
                            <button type="button" value="draft" class="btn btn-success" onclick="notifSave($('#formsubmit'),$(this).val());">Return</button>
                        </div>
                    </div>
                </div>
            }
            else if (ViewBag.kondisi == "konfirmasi")
            {
                @Html.Partial("SalesOrderKontrak/_OperationalTruckKonfirmasi", Model)
            }

            <a href="@backLink">Back to list</a>
        }
    </div>
</div>
<div id="ModalHistoryJalan" class="modal fade bs-modal-full" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-full">
        <div id="modalForm" class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">List Sales Order</h4>
            </div>
            <div class="modal-body">
                <div id="GridHistoryJalanDriver"></div>
            </div>
        </div>
    </div>
</div>
<div id="modalGridCust" class="modal fade bs-modal-lg" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div id="modalForm" class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">List Customer</h4>
            </div>
            <div class="modal-body">
                <div id="GridCust"></div>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script type="text/javascript">
        var date_selected = [], event_soure = [];
        var calendarKontrak;
        var date_selected_baru = [];
        var calendarKontrakBaru;

        @if (Model.JsonDateMuat != null && Model.JsonDateMuat != "")
        {
            foreach (var item in Model.JsonDateMuat.Split('|'))
            {
                <text>
        date_selected.push('@item');
        event_soure.push({ title: '', start: '@DateTime.Parse(item).Year' + '-' + '@DateTime.Parse(item).Month.ToString("00")' + '-' + '@DateTime.Parse(item).Day.ToString("00")', allDay: true });
        </text>
            }
        }

        $(document).ready(function () {
            @if (ViewBag.errorMsg != null)
            {
                <text>
                swal({
                    title: "Error",
                    type: 'error',
                    text: '@ViewBag.errorMsg',
                    showCloseButton: true,
                })
                </text>
            }

            CreateDateRange($('#PeriodStr'), $('#PeriodEnd'));

            calendarKontrak = $('#calendars').fullCalendar({
                header: {
                    right: 'prev || next'
                },

            });
            $('#calendars').fullCalendar('addEventSource', event_soure)

            calendarKontrakBaru = $('#calendarMuatBaru').fullCalendar({
                header: {
                    right: 'prev || next'
                },
                dayClick: function (date, allDay, jsEvent, view) {
                    // ambil date value
                    var data = date.format('DD/MM/YYYY');
                    var dayname = date.format('dddd');
                    // ambil index dalam array
                    var index = $.inArray(data, date_selected_baru);
                    //cek apakah sudah ada event pada hari bersangkutan
                    var date2 = new Date(date.year(), date.month(), date.date() + 1);
                    var todaysEvents = $('#calendarMuatBaru').fullCalendar('clientEvents', function (event) {
                        return event.start >= date && event.start < date2;
                    });
                    // cek array
                    if (index === -1) {
                        var periodeStart = new Date(getDateFromFormat($('#PeriodStr').val(), "dd/MM/yyyy"));
                        var periodeEnd = new Date(getDateFromFormat($('#PeriodEnd').val(), "dd/MM/yyyy"));
                        var currentDate = new Date(getDateFromFormat(data, "dd/MM/yyyy"));
                        if (currentDate >= periodeStart && currentDate <= periodeEnd) {
                            date_selected_baru.push(data);
                            $('#calendarMuatBaru').fullCalendar('renderEvent', { start: date, allDay: true }, true);
                        }
                    } else if (index !== -1) {
                        date_selected_baru.splice(index, 1);
                        $('#calendarMuatBaru').fullCalendar('removeEvents', todaysEvents[0]._id);
                    }
                    //paksakeun
                    $('#JsonDateMuatBaru').val(date_selected_baru.join('|'));
                    console.log($('#JsonDateMuatBaru').val(date_selected_baru.join('|')));
                },
                eventClick: function (calEvent, jsEvent, view) {
                    //hapus array
                    console.log(calEvent)
                    var data = calEvent.start.format('DD/MM/YYYY');
                    var dayname = calEvent.start.format('dddd');
                    var index = $.inArray(data, date_selected_baru);
                    date_selected_baru.splice(index, 1);
                    $('#JsonDateMuatBaru').val(date_selected_baru.join('|'));
                    //hapus event
                    $('#calendarMuatBaru').fullCalendar('removeEvents', calEvent._id);
                },
            });

            $('#calendarMuatBaru').fullCalendar('gotoDate', $("#PeriodStr").data('kendoDatePicker').value());


            @if(Model.PeriodStr.HasValue)
        {
            <text>
            $('#calendars').fullCalendar('gotoDate', $("#PeriodStr").data('kendoDatePicker').value());

            </text>
        }
        })
    </script>
    @if (ViewBag.kondisi == "inputdp")
    {
        <script src="~/Content/SalesOrderKontrak/inputdp.js"></script>
    }
    @if (ViewBag.kondisi == "planning" )
    {
        <script src="~/Content/OperationalKontrak/TruckDetail.js"></script>
        <script src="~/Content/OperationalKontrak/Import.js"></script>
        <script src="~/Content/DataTruk/TruckDetail.js"></script>
        <script src="~/Content/Driver/InitialGridSo.js"></script>
    }
    @if (ViewBag.kondisi == "konfirmasi")
    {
        <script src="~/Content/OperationalKontrak/TruckDetailKonfirmasi.js"></script>
        <script src="~/Content/DataTruk/TruckDetailKonfirmasiPlanning.js"></script>
        <script src="~/Content/Driver/InitialGridSo.js"></script>
    }
}